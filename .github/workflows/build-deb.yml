name: Build and Package .deb

on:
  push:
    tags:
      - 'v*'  # Ã–rn: v1.0.0 gibi tag atÄ±ldÄ±ÄŸÄ±nda tetiklenir

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v3

      - name: âš™ï¸ Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: ğŸ›  Build Go binary
        run: |
          mkdir -p build/usr/local/bin
          go build -o build/usr/local/bin/procguard-agent ./cmd/server/main.go

      - name: ğŸ“¦ Create DEBIAN control file
        run: |
          mkdir -p build/DEBIAN
          cat <<EOF > build/DEBIAN/control
Package: procguard-agent
Version: ${GITHUB_REF_NAME#v}
Section: base
Priority: optional
Architecture: amd64
Depends:
Maintainer: Your Name <you@example.com>
Description: ProcGuard Agent collects and reports system stats for monitoring.
EOF

      - name: ğŸ§¹ Fix Permissions
        run: chmod 755 build/DEBIAN

      - name: ğŸ“¦ Build .deb Package
        run: |
          dpkg-deb --build build procguard-agent_${GITHUB_REF_NAME#v}_amd64.deb

      - name: ğŸ“¤ Upload .deb Artifact
        uses: actions/upload-artifact@v3
        with:
          name: procguard-agent
          path: procguard-agent_*.deb
