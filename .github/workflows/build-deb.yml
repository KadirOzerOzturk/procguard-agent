name: ProcGuard Agent Build and Release

on:
  push:
    tags:
      - 'v*'       
  workflow_dispatch:

jobs:
  naming:
    runs-on: ubuntu-latest
    steps:
    - id: naming
      run: |
        echo "::set-output name=prerelease::false"
        echo "::set-output name=name::ProcGuard Agent Release ${{ github.run_number }}"
        echo "::set-output name=tag_name::v${{ github.run_number }}"
    outputs:
      prerelease: ${{ steps.naming.outputs.prerelease }}
      name: ${{ steps.naming.outputs.name }}
      tag_name: ${{ steps.naming.outputs.tag_name }}

  build:
    needs: naming
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'

    - name: Build ProcGuard Agent Binary
      run: |
        go mod tidy
        CGO_ENABLED=0 go build -o procguard-agent ./cmd/server/main.go

    - name: Install packaging tools
      run: sudo apt-get update && sudo apt-get install -y rpm dpkg fakeroot

    - name: Create DEB and RPM package
      run: |
        VERSION=${{ github.run_number }}
        TMP_DIR=/tmp/procguard-agent-build
        DEBIAN_PATH=$TMP_DIR/DEBIAN
        BIN_PATH=$TMP_DIR/usr/local/bin

        rm -rf $TMP_DIR
        mkdir -p $DEBIAN_PATH
        mkdir -p $BIN_PATH

        cp procguard-agent $BIN_PATH/procguard-agent
        cp debian/control $DEBIAN_PATH/control
        sed -i "s/%VERSION%/$VERSION/g" $DEBIAN_PATH/control

        fakeroot dpkg-deb --build $TMP_DIR
        mv $TMP_DIR.deb /tmp/procguard-agent-${VERSION}-x64.deb

        mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
        cp procguard-agent ~/rpmbuild/SOURCES/
        rpmbuild -bb scripts/redhat/app.spec \
          --define "_topdir ~/rpmbuild" \
          --define "version $VERSION" \
          --define "_rpmdir /tmp" \
          --define "_rpmfilename procguard-agent-${VERSION}-x64.rpm"

    - name: Release to GitHub
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: |
          /tmp/procguard-agent-${{ github.run_number }}-x64.deb
          /tmp/procguard-agent-${{ github.run_number }}-x64.rpm
        name: "${{ needs.naming.outputs.name }}"
        tag_name: "${{ needs.naming.outputs.tag_name }}"
        prerelease: ${{ needs.naming.outputs.prerelease }}
